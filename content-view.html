<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loading... | Post-Labor Economics</title>
  
  <link rel="icon" type="image/svg+xml" href="ple-logo.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,500;9..144,600;9..144,700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="src/styles/brand.css">
  <link rel="stylesheet" href="src/styles/app.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    .content-view-header {
      background: linear-gradient(135deg, var(--color-horizon) 0%, var(--color-horizon-dark, #153d31) 100%);
      color: white;
      padding: 3rem 0;
      margin-bottom: 2rem;
    }

    .content-view-header .container {
      max-width: 900px;
    }

    .content-breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      opacity: 0.8;
      margin-bottom: 1rem;
    }

    .content-breadcrumb a {
      color: white;
      text-decoration: none;
    }

    .content-breadcrumb a:hover {
      text-decoration: underline;
    }

    .content-type-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: rgba(255,255,255,0.2);
      margin-bottom: 1rem;
    }

    .content-view-title {
      font-family: var(--font-display);
      font-size: 2.5rem;
      font-weight: 600;
      margin: 0 0 1rem 0;
      line-height: 1.2;
    }

    .content-meta-row {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex-wrap: wrap;
      font-size: 0.875rem;
      opacity: 0.9;
    }

    .content-meta-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .author-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .content-body-wrapper {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 1rem 4rem;
    }

    .content-body {
      background: white;
      border-radius: 12px;
      padding: 2.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .content-body h1 {
      font-family: var(--font-display);
      font-size: 2rem;
      color: var(--color-horizon);
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--color-dawn);
    }

    .content-body h1:first-child {
      margin-top: 0;
    }

    .content-body h2 {
      font-family: var(--font-display);
      font-size: 1.5rem;
      color: var(--text-primary);
      margin: 1.75rem 0 0.75rem;
    }

    .content-body h3 {
      font-family: var(--font-display);
      font-size: 1.25rem;
      color: var(--text-primary);
      margin: 1.5rem 0 0.5rem;
    }

    .content-body p {
      line-height: 1.7;
      margin: 0 0 1rem;
      color: var(--text-secondary);
    }

    .content-body ul, .content-body ol {
      margin: 0 0 1rem;
      padding-left: 1.5rem;
    }

    .content-body li {
      line-height: 1.7;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    .content-body strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .content-body blockquote {
      border-left: 4px solid var(--color-dawn);
      margin: 1.5rem 0;
      padding: 1rem 1.5rem;
      background: var(--surface-secondary);
      border-radius: 0 8px 8px 0;
    }

    .content-body blockquote p {
      margin: 0;
      font-style: italic;
    }

    .content-body code {
      background: var(--surface-secondary);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .content-body pre {
      background: var(--surface-secondary);
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      margin: 1rem 0;
    }

    .content-body pre code {
      background: none;
      padding: 0;
    }

    .content-tags {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border-color);
    }

    .content-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.375rem 0.75rem;
      background: var(--surface-secondary);
      border-radius: 9999px;
      font-size: 0.8125rem;
      color: var(--text-secondary);
    }

    .content-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border-color);
    }

    .loading-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    .error-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--color-error, #dc2626);
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.875rem;
      margin-bottom: 2rem;
    }

    .back-link:hover {
      color: var(--color-horizon);
    }

    @media print {
      .header, .back-link, #reading-progress, #related-section, .comments-section,
      #workflow-banner, footer, button, .content-meta-item:last-child { display: none !important; }
      .content-view-header { background: none !important; color: #000 !important; padding: 1rem 0; }
      .content-view-header h1 { color: #000 !important; font-size: 1.75rem; }
      body { font-size: 12pt; }
      .content-body-wrapper { padding: 0; max-width: 100%; }
      a { color: #1B4D3E; }
    }
  </style>
</head>
<body>
  <div id="reading-progress" style="position:fixed;top:0;left:0;height:3px;background:var(--color-horizon,#1B4D3E);width:0;z-index:9999;transition:width 0.1s;"></div>
  <!-- Header -->
  <header class="header">
    <div class="header-container">
      <a href="index.html" class="logo">
        <span class="logo-symbol">L/0</span>
        <span class="logo-text">Post-Labor Economics</span>
      </a>
      
      <button class="nav-toggle" onclick="document.querySelector('.nav-menu').classList.toggle('open')" aria-label="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
      <nav class="nav-menu">
        <a href="projects.html" class="nav-link">Projects</a>
        <a href="content.html" class="nav-link active">Content</a>
        <a href="proposals.html" class="nav-link">Proposals</a>
        <a href="discussions.html" class="nav-link">Discussions</a>
        <a href="architecture.html" class="nav-link">Architecture</a>
      </nav>
      
      <div class="header-actions">
        <a href="search.html" class="nav-link" style="padding:0.4rem;display:flex;" title="Search"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></a>
        <a href="login.html" class="btn btn-ghost" data-auth="logged-out">Sign In</a>
        <a href="dashboard.html" class="btn btn-primary" data-auth="logged-in" style="display:none">Dashboard</a>
      </div>
    </div>
  </header>

  <div id="content-header" class="content-view-header" style="display: none;">
    <div class="container">
      <div class="content-breadcrumb">
        <a href="content.html">Content</a>
        <span>/</span>
        <span id="content-type-text">Article</span>
      </div>
      <span class="content-type-badge" id="content-type-badge">Article</span>
      <h1 class="content-view-title" id="content-title">Loading...</h1>
      <div class="content-meta-row">
        <div class="content-meta-item">
          <div class="author-avatar" id="author-avatar">?</div>
          <span id="author-name">Unknown</span>
        </div>
        <div class="content-meta-item">
          <i data-lucide="calendar" style="width: 16px; height: 16px;"></i>
          <span id="publish-date">‚Äî</span>
        </div>
        <div class="content-meta-item">
          <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
          <span id="read-time">‚Äî min read</span>
        </div>
        <div class="content-meta-item" id="project-link" style="display:none">
          <i data-lucide="folder" style="width: 16px; height: 16px;"></i>
          <a id="project-link-text" href="#" style="color:inherit;text-decoration:none;border-bottom:1px dashed #ccc"></a>
        </div>
        <div class="content-meta-item" style="margin-left:auto;">
          <button onclick="copyLink()" style="background:none;border:1px solid var(--border-color,#e5e2dd);padding:0.3rem 0.6rem;border-radius:6px;cursor:pointer;font-size:0.8rem;color:var(--text-muted);font-family:inherit;display:flex;align-items:center;gap:0.3rem;" title="Copy link">
            <i data-lucide="link" style="width:14px;height:14px;"></i> Share
          </button>
        </div>
      </div>
    </div>
  </div>

  <main class="content-body-wrapper">
    <a href="content.html" class="back-link">
      <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
      Back to Content
    </a>

    <div id="loading-state" class="loading-state">
      <p>Loading content...</p>
    </div>

    <div id="error-state" class="error-state" style="display: none;">
      <p>Content not found or could not be loaded.</p>
      <a href="content.html" class="btn btn-primary" style="margin-top: 1rem;">Browse All Content</a>
    </div>

    <div id="content-body" class="content-body" style="display: none;">
      <!-- Workflow Banner -->
      <div id="workflow-banner" style="display:none; padding:1rem 1.25rem; border-radius:8px; margin-bottom:1.5rem; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:0.75rem;"></div>

      <div id="content-html"></div>
      
      <div id="content-tags" class="content-tags" style="display: none;"></div>
      
      <div id="content-actions" class="content-actions" style="display: none;">
        <button class="btn btn-ghost" onclick="editContent()">
          <i data-lucide="edit" style="width: 16px; height: 16px;"></i>
          Edit
        </button>
        <button class="btn btn-ghost" onclick="deleteContent()" style="color:#991B1B;">
          <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
          Delete
        </button>
      </div>

      <!-- Related Content -->
      <div id="related-section" style="display:none;margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border-color);">
        <h3 style="font-family:var(--font-display);font-size:1.15rem;margin-bottom:1rem;">Related Content</h3>
        <div id="related-list" style="display:grid;gap:0.75rem;"></div>
      </div>

      <!-- Comments Section -->
      <div class="comments-section" style="margin-top:3rem; padding-top:2rem; border-top:1px solid var(--border-color);">
        <h3 style="font-family:var(--font-display); margin-bottom:1.5rem;">Discussion</h3>
        <div id="comment-form-area" style="display:none; margin-bottom:2rem;">
          <textarea id="comment-body" rows="3" placeholder="Share your thoughts..." style="width:100%;padding:0.75rem 1rem;border:1px solid var(--border-color);border-radius:8px;font-family:inherit;font-size:0.95rem;resize:vertical;background:var(--bg-secondary);"></textarea>
          <div style="display:flex;justify-content:flex-end;margin-top:0.5rem;"><button class="btn btn-primary" onclick="postComment()">Post Comment</button></div>
        </div>
        <div id="comments-list"></div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-brand">
          <span class="logo-symbol">L/0</span>
          <p>Building frameworks for prosperity beyond work.</p>
        </div>
        <div class="footer-links">
          <a href="about.html">About</a>
          <a href="architecture.html">Architecture</a>
          <a href="https://github.com/sillinous/ple-platform" target="_blank">GitHub</a>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2026 Post-Labor Economics Platform. Open source under MIT License.</p>
      </div>
    </div>
  </footer>

  <script>
    let currentContent = null, currentUser = null, contentComments = [];
    const authH = () => { const h={'Content-Type':'application/json'}; const t=localStorage.getItem('ple_token'); if(t) h['Authorization']=`Bearer ${t}`; return h; };
    function toast(msg,type='success'){const t=document.createElement('div');t.style.cssText='position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(100px);background:'+(type==='error'?'#991B1B':'#1B4D3E')+';color:white;padding:0.75rem 1.5rem;border-radius:8px;font-size:0.9rem;box-shadow:0 4px 20px rgba(0,0,0,0.2);z-index:10000;transition:transform 0.3s';
      t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.style.transform='translateX(-50%) translateY(0)',10);setTimeout(()=>{t.style.transform='translateX(-50%) translateY(100px)';setTimeout(()=>t.remove(),300)},3000);}

    document.addEventListener('DOMContentLoaded', async () => {
      lucide.createIcons(); await checkAuth(); await loadContent();
    });

    async function checkAuth() {
      try { const token=localStorage.getItem('ple_token'); if(!token) return;
        const r=await fetch('/api/auth?action=me',{headers:{'Authorization':`Bearer ${token}`}});
        if(r.ok){currentUser=await r.json(); if(currentUser.user) currentUser=currentUser.user;
          document.querySelectorAll('[data-auth="logged-in"]').forEach(el=>el.style.display='');
          document.querySelectorAll('[data-auth="logged-out"]').forEach(el=>el.style.display='none');
          document.getElementById('comment-form-area').style.display='block';
        }
      }catch(e){console.error('Auth:',e);}
    }

    async function loadContent() {
      const id=new URLSearchParams(window.location.search).get('id');
      if(!id){showError();return;}
      try{const r=await fetch(`/api/content?id=${id}`,{headers:authH()});
        if(!r.ok){showError();return;} const data=await r.json();
        if(!data.content){showError();return;}
        currentContent=data.content; currentContent.tags=data.tags||[];
        currentContent.versionCount=data.versionCount||0;
        contentComments=data.comments||[];
        renderContent(currentContent); renderComments(contentComments);
      }catch(e){console.error(e);showError();}
    }

    function renderContent(item) {
      document.title=`${item.title} | Post-Labor Economics`;
      document.getElementById('content-header').style.display='';
      const typeLabel=(item.contentType||'article').replace('_',' ');
      document.getElementById('content-type-text').textContent=typeLabel;
      document.getElementById('content-type-badge').textContent=typeLabel;
      document.getElementById('content-title').textContent=item.title;
      const authorName=item.author?.name||'Unknown';
      document.getElementById('author-avatar').textContent=authorName.split(' ').map(n=>n[0]).join('').toUpperCase();
      document.getElementById('author-name').innerHTML=item.author?.id ? '<a href="profile.html?id='+item.author.id+'" style="color:inherit;text-decoration:none;border-bottom:1px dashed var(--border-color,#ccc)">'+authorName+'</a>' : authorName;
      const pubDate=item.publishedAt||item.createdAt;
      if(pubDate) document.getElementById('publish-date').textContent=new Date(pubDate).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
      const words=(item.body||'').split(/\s+/).length;
      document.getElementById('read-time').textContent=`${Math.max(1,Math.ceil(words/200))} min read`;
      if(item.project?.id){const pl=document.getElementById('project-link');pl.style.display='flex';const a=document.getElementById('project-link-text');a.href='project-view.html?id='+item.project.id;a.textContent=item.project.title;}
      document.getElementById('content-html').innerHTML=marked.parse(item.body||'');
      if(item.tags?.length){const tc=document.getElementById('content-tags');
        tc.innerHTML=item.tags.map(t=>`<span class="content-tag"><i data-lucide="tag" style="width:12px;height:12px"></i> ${escapeHtml(t)}</span>`).join('');
        tc.style.display='';lucide.createIcons();}
      const canEdit=currentUser&&(currentUser.role==='admin'||currentUser.role==='editor'||(item.author&&item.author.id===currentUser.id));
      if(canEdit) document.getElementById('content-actions').style.display='';

      // Workflow banner
      renderWorkflow(item,canEdit);

      document.getElementById('loading-state').style.display='none';
      document.getElementById('content-body').style.display='';
      lucide.createIcons();
      loadRelated(item.id, item.tags||[]);
      generateTOC();
      if(typeof hljs!=='undefined') document.querySelectorAll('#content-html pre code').forEach(el=>hljs.highlightElement(el));
    }

    function renderWorkflow(item, canEdit) {
      const banner=document.getElementById('workflow-banner');
      if(!currentUser||item.status==='published'){banner.style.display='none';return;}
      banner.style.display='flex';
      const isAuthor=item.author&&item.author.id===currentUser.id;
      const isEditor=currentUser.role==='admin'||currentUser.role==='editor';
      let bg='var(--color-gray-50)',msg='',buttons='';
      if(item.status==='draft'){bg='#F3F4F6';msg='üìù This content is a <strong>draft</strong>.';
        if(isAuthor)buttons=`<button class="btn btn-secondary" onclick="workflowAction('submit')">Submit for Review</button>`;}
      else if(item.status==='in_review'){bg='#FEF3C7';msg='‚è≥ This content is <strong>awaiting review</strong>.';
        if(isEditor)buttons=`<button class="btn btn-secondary" onclick="workflowAction('approve')">Approve</button><button class="btn btn-primary" onclick="workflowAction('publish')">Publish Now</button>`;}
      else if(item.status==='approved'){bg='#D1FAE5';msg='‚úÖ This content has been <strong>approved</strong>.';
        if(isAuthor||isEditor)buttons=`<button class="btn btn-primary" onclick="workflowAction('publish')">Publish</button>`;}
      banner.style.background=bg;
      banner.innerHTML=`<span>${msg}${item.versionCount>0?` ¬∑ v${item.version} (${item.versionCount} versions)`:''}</span><div style="display:flex;gap:0.5rem">${buttons}</div>`;
    }

    async function workflowAction(action) {
      const r=await fetch(`/api/content?action=${action}`,{method:'POST',headers:authH(),body:JSON.stringify({id:currentContent.id})});
      if(r.ok){toast(action==='submit'?'Submitted for review':action==='approve'?'Approved':'Published!');loadContent();}
      else{const e=await r.json();toast(e.error||'Failed','error');}
    }

    // Comments
    function renderComments(comments) {
      const list=document.getElementById('comments-list');
      if(!comments.length){list.innerHTML='<p style="color:var(--text-muted);font-size:0.9rem">No comments yet. Be the first to share your thoughts.</p>';return;}
      list.innerHTML=comments.map(c=>{
        const name=c.author_name||'Anonymous';
        const ini=name.split(' ').map(n=>n[0]).join('').toUpperCase();
        const date=new Date(c.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
        const replies=(c.replies||[]).map(r=>{
          const rn=r.author_name||'Anonymous';
          return`<div style="margin-left:2.5rem;padding:0.75rem 0;border-top:1px solid var(--border-color)">
            <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem">
              <div style="width:24px;height:24px;border-radius:50%;background:var(--color-sage);color:white;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:600">${rn.split(' ').map(n=>n[0]).join('').toUpperCase()}</div>
              <strong style="font-size:0.85rem">${escapeHtml(rn)}</strong>
              <span style="font-size:0.8rem;color:var(--text-muted)">${new Date(r.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>
            </div><div style="font-size:0.9rem;color:var(--text-secondary);line-height:1.6">${escapeHtml(r.body)}</div></div>`;
        }).join('');
        return`<div style="padding:1rem 0;border-bottom:1px solid var(--border-color)">
          <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem">
            <div style="width:32px;height:32px;border-radius:50%;background:var(--color-horizon);color:white;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:600">${ini}</div>
            <div><strong>${escapeHtml(name)}</strong><span style="font-size:0.8rem;color:var(--text-muted);margin-left:0.5rem">${date}</span></div>
          </div><div style="font-size:0.95rem;color:var(--text-secondary);line-height:1.7;margin-left:2.5rem">${escapeHtml(c.body)}</div>
          ${currentUser?`<div style="margin-left:2.5rem;margin-top:0.5rem"><button onclick="showReply('${c.id}')" style="background:none;border:none;color:var(--color-horizon);cursor:pointer;font-size:0.85rem;padding:0">Reply</button></div>
          <div id="reply-${c.id}" style="display:none;margin-left:2.5rem;margin-top:0.5rem">
            <textarea id="reply-body-${c.id}" rows="2" placeholder="Write a reply..." style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border-color);border-radius:6px;font-family:inherit;font-size:0.9rem;resize:vertical"></textarea>
            <div style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:0.35rem"><button class="btn btn-ghost" onclick="hideReply('${c.id}')" style="font-size:0.85rem;padding:0.3rem 0.6rem">Cancel</button><button class="btn btn-primary" onclick="postReply('${c.id}')" style="font-size:0.85rem;padding:0.3rem 0.6rem">Reply</button></div></div>`:''
          }${replies}</div>`;
      }).join('');
    }

    function showReply(id){document.getElementById(`reply-${id}`).style.display='block';}
    function hideReply(id){document.getElementById(`reply-${id}`).style.display='none';}

    async function postComment() {
      const body=document.getElementById('comment-body').value.trim();
      if(!body){toast('Write something first','error');return;}
      const btn=document.querySelector('#comment-form-area .btn');
      if(btn){btn.disabled=true;btn.textContent='Posting...';}
      try{
        const r=await fetch('/api/comments',{method:'POST',headers:authH(),
          body:JSON.stringify({entity_type:'content',entity_id:currentContent.id,body})});
        if(r.ok){document.getElementById('comment-body').value='';toast('Comment posted');loadContent();
          setTimeout(()=>{const cl=document.getElementById('comments-list');if(cl)cl.scrollIntoView({behavior:'smooth',block:'start'});},500);
        }else{const e=await r.json();toast(e.error||'Failed','error');}
      }catch(e){toast('Failed to post comment','error');}
      finally{if(btn){btn.disabled=false;btn.textContent='Post Comment';}}
    }

    async function postReply(parentId) {
      const body=document.getElementById(`reply-body-${parentId}`).value.trim();
      if(!body)return;
      const r=await fetch('/api/comments',{method:'POST',headers:authH(),
        body:JSON.stringify({entity_type:'content',entity_id:currentContent.id,body,parent_id:parentId})});
      if(r.ok){toast('Reply posted');loadContent();}
      else{const e=await r.json();toast(e.error||'Failed','error');}
    }

    function showError(){document.getElementById('loading-state').style.display='none';document.getElementById('error-state').style.display='';}

    window.copyLink = function() {
      navigator.clipboard.writeText(window.location.href).then(()=>{
        toast('Link copied to clipboard');
      }).catch(()=>{
        // Fallback
        const ta=document.createElement('textarea');ta.value=window.location.href;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
        toast('Link copied to clipboard');
      });
    };

    async function loadRelated(currentId, tags) {
      if(!tags?.length) return;
      try{
        const r=await fetch('/api/content?limit=20&status=published');const d=await r.json();
        const related=(d.content||[]).filter(c=>c.id!==currentId&&(c.tags||[]).some(t=>tags.includes(t))).slice(0,3);
        if(!related.length) return;
        document.getElementById('related-section').style.display='block';
        document.getElementById('related-list').innerHTML=related.map(c=>
          `<a href="content-view.html?id=${c.id}" style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;border:1px solid var(--border-color,#e5e2dd);border-radius:8px;text-decoration:none;color:inherit;transition:background 0.1s;"><div><div style="font-weight:500;font-size:0.9rem;">${c.title}</div><div style="font-size:0.8rem;color:var(--text-muted,#888);margin-top:0.15rem;">${(c.tags||[]).join(', ')}</div></div><span style="font-size:0.75rem;color:var(--color-horizon,#1B4D3E);">Read &rarr;</span></a>`
        ).join('');
      }catch(e){}
    }
    function editContent(){if(currentContent)window.location=`/content-editor.html?id=${currentContent.id}`;}
    async function deleteContent(){
      if(!currentContent)return;
      if(!confirm('Delete this content? This cannot be undone.'))return;
      try{const token=localStorage.getItem('ple_token');
        const r=await fetch(`/api/content?id=${currentContent.id}`,{method:'DELETE',headers:{'Authorization':'Bearer '+token}});
        if(r.ok){toast('Content deleted');setTimeout(()=>window.location='/content.html',1000);}
        else{const d=await r.json();toast(d.error||'Failed to delete','error');}
      }catch(e){toast('Failed to delete','error');}
    }
    function escapeHtml(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

    // Reading progress bar
    window.addEventListener('scroll',()=>{
      const h=document.documentElement.scrollHeight-window.innerHeight;
      const p=h>0?Math.min(100,(window.scrollY/h)*100):0;
      document.getElementById('reading-progress').style.width=p+'%';
    });

    // Auto-generate table of contents for long articles
    function generateTOC(){
      const html=document.getElementById('content-html');
      if(!html)return;
      const headings=html.querySelectorAll('h2,h3');
      if(headings.length<3)return;
      const toc=document.createElement('nav');
      toc.style.cssText='background:var(--bg-secondary,#f5f3f0);border:1px solid var(--border-color,#e5e2dd);border-radius:10px;padding:1.25rem 1.5rem;margin-bottom:2rem;';
      toc.innerHTML='<div style="font-weight:600;font-size:0.85rem;margin-bottom:0.75rem;color:var(--text-muted,#888);text-transform:uppercase;letter-spacing:0.5px;">Contents</div>';
      const list=document.createElement('div');
      list.style.cssText='display:flex;flex-direction:column;gap:0.35rem;';
      headings.forEach((h,i)=>{
        const id='section-'+i;h.id=id;
        const a=document.createElement('a');
        a.href='#'+id;a.textContent=h.textContent;
        a.style.cssText='color:var(--color-horizon,#1B4D3E);text-decoration:none;font-size:0.85rem;padding:'+(h.tagName==='H3'?'0 0 0 1rem':'0')+';';
        a.addEventListener('click',e=>{e.preventDefault();h.scrollIntoView({behavior:'smooth',block:'start'});});
        list.appendChild(a);
      });
      toc.appendChild(list);
      html.insertBefore(toc,html.firstChild);
    }
  </script>
</body>
</html>
