<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Assistant | Post-Labor Economics</title>
  <link rel="icon" type="image/svg+xml" href="ple-logo.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,500;9..144,600;9..144,700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="src/styles/brand.css">
  <link rel="stylesheet" href="src/styles/app.css">
  <style>
    .chat-container { max-width: 800px; margin: 0 auto; padding: 1.5rem; display: flex; flex-direction: column; height: calc(100vh - 80px); }
    .chat-header { text-align: center; padding: 1.5rem 0 1rem; flex-shrink: 0; }
    .chat-header h1 { font-family: 'Fraunces', serif; font-size: 1.8rem; color: var(--color-horizon); }
    .chat-header p { color: var(--text-muted); margin-top: 0.3rem; font-size: 0.9rem; }
    .chat-kb-badge { display: inline-flex; align-items: center; gap: 0.4rem; background: var(--color-dawn-10, rgba(244,162,97,0.1)); color: var(--color-dawn); font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.75rem; border-radius: 1rem; margin-top: 0.5rem; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 1rem 0; display: flex; flex-direction: column; gap: 1rem; }
    .chat-msg { max-width: 85%; padding: 0.85rem 1.1rem; border-radius: 1rem; line-height: 1.55; font-size: 0.92rem; animation: msgIn 0.25s ease; }
    .chat-msg.user { align-self: flex-end; background: var(--color-horizon); color: #fff; border-bottom-right-radius: 0.3rem; }
    .chat-msg.assistant { align-self: flex-start; background: var(--bg-card, #f8f6f3); border: 1px solid var(--border-light, #e8e4df); border-bottom-left-radius: 0.3rem; color: var(--text-primary); }
    .chat-msg.assistant h2,.chat-msg.assistant h3 { font-family: 'Fraunces', serif; margin: 0.8rem 0 0.4rem; font-size: 1rem; color: var(--color-horizon); }
    .chat-msg.assistant strong { color: var(--color-horizon); }
    .chat-msg.assistant ul,.chat-msg.assistant ol { padding-left: 1.2rem; margin: 0.4rem 0; }
    .chat-msg.assistant li { margin-bottom: 0.3rem; }
    .chat-msg.assistant code { background: rgba(0,0,0,0.06); padding: 0.15rem 0.35rem; border-radius: 3px; font-size: 0.85em; }
    .chat-msg.assistant p { margin: 0.4rem 0; }
    .chat-msg.assistant p:first-child { margin-top: 0; }
    .chat-msg.assistant p:last-child { margin-bottom: 0; }
    .chat-meta { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.4rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .chat-meta span { background: var(--bg-subtle, #f0ede8); padding: 0.1rem 0.4rem; border-radius: 3px; }
    .chat-welcome { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
    .chat-welcome h2 { font-family: 'Fraunces', serif; color: var(--color-horizon); margin-bottom: 1rem; font-size: 1.3rem; }
    .chat-starters { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; margin-top: 1.2rem; }
    .chat-starter { background: var(--bg-card, #f8f6f3); border: 1px solid var(--border-light, #e8e4df); padding: 0.5rem 0.9rem; border-radius: 0.7rem; font-size: 0.82rem; cursor: pointer; transition: all 0.2s; color: var(--text-primary); }
    .chat-starter:hover { border-color: var(--color-dawn); background: rgba(244,162,97,0.05); }
    .chat-input-area { flex-shrink: 0; padding: 1rem 0 0.5rem; border-top: 1px solid var(--border-light, #e8e4df); }
    .chat-input-row { display: flex; gap: 0.5rem; }
    .chat-input { flex: 1; padding: 0.75rem 1rem; border: 1.5px solid var(--border-light, #e8e4df); border-radius: 0.8rem; font-family: 'Inter', sans-serif; font-size: 0.92rem; background: var(--bg-card, #fff); color: var(--text-primary); resize: none; outline: none; transition: border-color 0.2s; min-height: 44px; max-height: 120px; }
    .chat-input:focus { border-color: var(--color-horizon); }
    .chat-send { background: var(--color-horizon); color: #fff; border: none; border-radius: 0.8rem; padding: 0 1.2rem; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: opacity 0.2s; }
    .chat-send:hover { opacity: 0.9; }
    .chat-send:disabled { opacity: 0.4; cursor: not-allowed; }
    .chat-typing { align-self: flex-start; padding: 0.7rem 1.1rem; background: var(--bg-card, #f8f6f3); border: 1px solid var(--border-light, #e8e4df); border-radius: 1rem; display: flex; gap: 0.3rem; }
    .chat-typing span { width: 6px; height: 6px; background: var(--color-dawn); border-radius: 50%; animation: bounce 1.2s infinite; }
    .chat-typing span:nth-child(2) { animation-delay: 0.2s; }
    .chat-typing span:nth-child(3) { animation-delay: 0.4s; }
    .chat-fallback { background: var(--color-dawn-10, rgba(244,162,97,0.1)); border: 1px solid var(--color-dawn); border-radius: 0.7rem; padding: 0.8rem 1rem; margin: 0.5rem 0; font-size: 0.85rem; color: var(--text-primary); }
    .chat-footer { text-align: center; font-size: 0.72rem; color: var(--text-muted); padding: 0.5rem 0; }
    @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes bounce { 0%,60%,100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }
  </style>
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://postlaboreconomics.netlify.app/og-image.svg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://postlaboreconomics.netlify.app/og-image.svg">
</head>
<body>
  <header class="header">
    <div class="header-container">
      <a href="index.html" class="logo"><span class="logo-symbol">L/0</span><span class="logo-text">Post-Labor Economics</span></a>
      <nav class="nav-menu">
        <a href="content.html" class="nav-link">Content</a>
        <a href="projects.html" class="nav-link">Projects</a>
        <a href="proposals.html" class="nav-link">Proposals</a>
        <a href="discussions.html" class="nav-link">Discussions</a>
        <a href="about.html" class="nav-link">About</a>
      </nav>
    </div>
  </header>

  <div class="chat-container">
    <div class="chat-header">
      <h1>PLE AI Assistant</h1>
      <p>Ask anything about Post-Labor Economics â€” grounded in David Shapiro's framework</p>
      <div class="chat-kb-badge">ðŸ“š Knowledge Base v2.0 Â· 19 sources Â· 15 framework sections</div>
    </div>

    <div class="chat-messages" id="messages">
      <div class="chat-welcome" id="welcome">
        <h2>What would you like to explore?</h2>
        <p>I'm trained on the full PLE framework â€” pyramids, principles, interventions, and real-world examples.</p>
        <div class="chat-starters">
          <button class="chat-starter" onclick="sendStarter(this)">What is Post-Labor Economics?</button>
          <button class="chat-starter" onclick="sendStarter(this)">Explain the Pyramid of Prosperity</button>
          <button class="chat-starter" onclick="sendStarter(this)">What are the three attractor states?</button>
          <button class="chat-starter" onclick="sendStarter(this)">How do the 16 property interventions work?</button>
          <button class="chat-starter" onclick="sendStarter(this)">What are the Four Human Offerings?</button>
          <button class="chat-starter" onclick="sendStarter(this)">Show me real-world examples of PLE</button>
        </div>
      </div>
    </div>

    <div class="chat-input-area">
      <div class="chat-input-row">
        <textarea class="chat-input" id="input" placeholder="Ask about PLE framework, automation, prosperity pyramids..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}" oninput="autoResize(this)"></textarea>
        <button class="chat-send" id="sendBtn" onclick="sendMessage()">Send</button>
      </div>
    </div>
    <div class="chat-footer">Powered by Claude Â· Grounded in PLE Knowledge Base Â· Responses may not always be accurate</div>
  </div>

  <script type="module">
    import { marked } from 'https://cdn.jsdelivr.net/npm/marked@12/lib/marked.esm.js';

    // Follow-up suggestions by KB section
    const FOLLOW_UPS = {
      core: ['What is the L/0 symbol?', 'How is PLE different from UBI?', 'Who created this framework?'],
      pyramid_of_prosperity: ['What are the 5 layers?', 'How do property interventions work?', 'Show me real-world examples'],
      pyramid_of_power: ['How does democracy survive automation?', 'What is the Fork Right?', 'Explain the Bedrock layer'],
      attractor_states: ['What is technofeudalism?', 'How do we reach techno-abundance?', 'What is normalcy bias?'],
      four_human_offerings: ['Which offerings are already automated?', 'Is empathy the last frontier?', 'What happens when all four are replaced?'],
      property_interventions: ['What are data royalties?', 'How do credit unions fit in?', 'What is the banking thesis?'],
      economic_agency: ['What are the agency principles?', 'How do I build financial authority?', 'What is time sovereignty?'],
      overview: ['Explain the core thesis', 'What problems does PLE solve?', 'How is this structured optimism?']
    };
    const DEFAULT_FOLLOW_UPS = ['What are the three attractor states?', 'Explain the 16 property interventions', 'Show me real-world examples'];

    function addFollowUps(sections) {
      const suggestions = [];
      for (const s of (sections || [])) {
        for (const f of (FOLLOW_UPS[s] || [])) {
          if (!suggestions.includes(f) && suggestions.length < 3) suggestions.push(f);
        }
      }
      if (suggestions.length === 0) suggestions.push(...DEFAULT_FOLLOW_UPS);
      const asked = new Set(history.filter(m => m.role === 'user').map(m => m.content.toLowerCase()));
      const filtered = suggestions.filter(s => !asked.has(s.toLowerCase()));
      if (filtered.length === 0) return;

      const wrap = document.createElement('div');
      wrap.className = 'chat-starters';
      wrap.style.cssText = 'justify-content:flex-start;padding:0.3rem 0 0.5rem;';
      for (const s of filtered) {
        const btn = document.createElement('button');
        btn.className = 'chat-starter';
        btn.textContent = s;
        btn.onclick = () => { wrap.remove(); inputEl.value = s; sendMessage(); };
        wrap.appendChild(btn);
      }
      messagesEl.appendChild(wrap);
      scrollToBottom();
    }

    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const welcomeEl = document.getElementById('welcome');
    
    let history = [];
    let sending = false;

    window.autoResize = function(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    };

    window.sendStarter = function(btn) {
      inputEl.value = btn.textContent;
      sendMessage();
    };

    window.sendMessage = async function() {
      const msg = inputEl.value.trim();
      if (!msg || sending) return;

      sending = true;
      sendBtn.disabled = true;
      inputEl.value = '';
      inputEl.style.height = 'auto';

      if (welcomeEl) welcomeEl.remove();

      // Add user message
      addMessage('user', msg);
      history.push({ role: 'user', content: msg });

      // Show typing
      const typingEl = document.createElement('div');
      typingEl.className = 'chat-typing';
      typingEl.innerHTML = '<span></span><span></span><span></span>';
      messagesEl.appendChild(typingEl);
      scrollToBottom();

      try {
        const token = localStorage.getItem('ple_token');
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;

        const res = await fetch('/api/chat', {
          method: 'POST',
          headers,
          body: JSON.stringify({ message: msg, history: history.slice(-6) })
        });

        const data = await res.json();
        typingEl.remove();

        if (data.fallback) {
          // API key not configured â€” use local KB fallback
          const fallbackMsg = await localFallback(msg);
          addMessage('assistant', fallbackMsg, null, true);
          history.push({ role: 'assistant', content: fallbackMsg });
        } else if (data.response) {
          addMessage('assistant', data.response, data.context);
          history.push({ role: 'assistant', content: data.response });
          // Remove old follow-ups and add new ones
          messagesEl.querySelectorAll('.chat-starters:not(#welcome *)').forEach(el => el.remove());
          if (data.context?.sections_used) addFollowUps(data.context.sections_used);
        } else {
          addMessage('assistant', data.error || 'Something went wrong. Please try again.');
        }
      } catch (e) {
        typingEl.remove();
        // Offline fallback
        const fallbackMsg = await localFallback(msg);
        addMessage('assistant', fallbackMsg, null, true);
        history.push({ role: 'assistant', content: fallbackMsg });
      }

      sending = false;
      sendBtn.disabled = false;
      inputEl.focus();
    };

    function addMessage(role, content, context, isFallback) {
      const div = document.createElement('div');
      div.className = `chat-msg ${role}`;
      
      if (role === 'assistant') {
        let html = marked.parse(content);
        if (isFallback) {
          html = `<div class="chat-fallback">ðŸ“š Answered from local knowledge base (AI service unavailable)</div>` + html;
        }
        div.innerHTML = html;
        if (context && context.sections_used) {
          const meta = document.createElement('div');
          meta.className = 'chat-meta';
          meta.innerHTML = context.sections_used.map(s => `<span>${s.replace(/_/g,' ')}</span>`).join('');
          div.appendChild(meta);
        }
      } else {
        div.textContent = content;
      }

      messagesEl.appendChild(div);
      scrollToBottom();
    }

    function scrollToBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Local KB fallback when AI API is unavailable
    async function localFallback(msg) {
      try {
        const kb = await (await fetch('/data/knowledge-base.json')).json();
        const q = msg.toLowerCase();
        const sections = [];

        if (q.match(/what is|intro|explain.*ple|post.?labor/)) {
          sections.push(`**Post-Labor Economics (L/0)** is ${kb.framework.core_thesis}\n\n${kb.framework.philosophy}`);
        }
        if (q.match(/prosper|pyramid.*prosper|income|ubi/)) {
          const pp = kb.framework.pyramid_of_prosperity;
          sections.push(`**${pp.description}**\n\n` + pp.layers.map(l => `- **Layer ${l.layer}: ${l.name}** â€” ${l.description}`).join('\n'));
        }
        if (q.match(/power|pyramid.*power|democra|govern/)) {
          const pp = kb.framework.pyramid_of_power;
          sections.push(`**${pp.description}**\n\n` + pp.layers.map(l => `- **Layer ${l.layer}: ${l.name}** â€” ${l.description}`).join('\n'));
        }
        if (q.match(/attractor|technofeud|trajectory|default/)) {
          const a = kb.framework.attractor_states;
          if (a) sections.push(`**${a.description}**\n\n` + a.states.map(s => `- **${s.name}** (${s.type}): ${s.description}`).join('\n\n'));
        }
        if (q.match(/four.*offer|strength|dexterity|cognit|empathy/)) {
          const f = kb.framework.four_human_offerings;
          if (f) sections.push(`**${f.description}**\n\n` + f.offerings.map(o => `- **${o.name}**: ${o.description}\n  *Status:* ${o.automation_status}`).join('\n\n'));
        }
        if (q.match(/property|intervention|dividend|16/)) {
          const p = kb.framework.property_interventions;
          if (p) sections.push(`**${p.description}**\n\n` + p.interventions.slice(0,8).map(i => `${i.id}. **${i.name}**: ${i.description}`).join('\n\n') + `\n\n*...and ${p.interventions.length - 8} more interventions.*`);
        }
        if (q.match(/example|alaska|mondragon|real.?world|proof/)) {
          sections.push(`**Real-World Examples:**\n\n` + kb.real_world_examples.map(e => `- **${e.name}**: ${e.description}`).join('\n'));
        }
        if (q.match(/concept|labor.?zero|decoupl|solarpunk/)) {
          sections.push(`**Key Concepts:**\n\n` + Object.entries(kb.key_concepts).map(([k,v]) => `- **${k.replace(/_/g,' ')}**: ${v.definition}`).join('\n'));
        }

        if (sections.length === 0) {
          sections.push(`I can help you explore the PLE framework! Try asking about:\n\n- The **Pyramid of Prosperity** (5-layer income framework)\n- The **Pyramid of Power** (democratic resilience)\n- The **16 property interventions** for post-labor income\n- **Attractor states** (technofeudalism vs techno-abundance)\n- The **Four Human Offerings** (what automation replaces)\n- **Real-world examples** (Alaska, Mondragon, Nordic model)\n- **Key concepts** (Labor Zero, Great Decoupling, Structured Optimism)`);
        }

        return sections.join('\n\n---\n\n');
      } catch (e) {
        return 'I\'m having trouble accessing the knowledge base. Please try again or visit the [Content section](/content) to explore PLE articles directly.';
      }
    }
  </script>
</body>
</html>
