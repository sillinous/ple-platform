<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile | Post-Labor Economics</title>
  <link rel="icon" type="image/svg+xml" href="ple-logo.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,500;9..144,600;9..144,700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="src/styles/brand.css">
  <link rel="stylesheet" href="src/styles/app.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .profile-container { max-width: 800px; margin: 0 auto; padding: 2rem 1.5rem 4rem; }
    .profile-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; }
    .profile-header { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; }
    .profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--color-horizon); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 600; flex-shrink: 0; }
    .profile-info h1 { font-family: var(--font-display); font-size: 1.75rem; margin: 0; }
    .profile-info .role-badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 100px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; background: rgba(27,77,62,0.1); color: var(--color-horizon); margin-top: 0.35rem; }
    .profile-info .member-since { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem; }
    .profile-form { display: grid; gap: 1.25rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.35rem; color: var(--text-secondary); }
    .form-group input, .form-group textarea { width: 100%; padding: 0.6rem 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; font-size: 0.95rem; background: var(--bg-primary); }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--color-horizon); }
    .form-group input[disabled] { background: var(--color-gray-50); color: var(--text-muted); cursor: not-allowed; }
    .form-actions { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 0.5rem; }
    .section-label { font-family: var(--font-display); font-size: 1.15rem; margin: 0 0 1rem; }
    .contrib-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 2rem; }
    .contrib-stat { text-align: center; padding: 1rem; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-primary); }
    .contrib-stat-value { font-family: var(--font-display); font-size: 1.75rem; font-weight: 600; color: var(--color-horizon); }
    .contrib-stat-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.15rem; }
    .contrib-list { border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; }
    .contrib-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid var(--color-gray-50); background: var(--bg-primary); text-decoration: none; color: inherit; transition: background 0.1s; }
    .contrib-item:last-child { border-bottom: none; }
    .contrib-item:hover { background: var(--bg-secondary); }
    .contrib-item-title { font-weight: 500; font-size: 0.9rem; }
    .contrib-item-meta { font-size: 0.8rem; color: var(--text-muted); }
    .contrib-item-badge { padding: 0.15rem 0.5rem; border-radius: 100px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; }
    .toast { position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(100px);background:#1B4D3E;color:white;padding:0.75rem 1.5rem;border-radius:8px;font-size:0.9rem;box-shadow:0 4px 20px rgba(0,0,0,0.2);z-index:10000;transition:transform 0.3s;pointer-events:none; }
    .toast.show { transform:translateX(-50%) translateY(0); }
    .toast-error { background:#991B1B; }
    @media(max-width:600px){ .form-row{grid-template-columns:1fr;} .contrib-grid{grid-template-columns:1fr 1fr;} .profile-header{flex-direction:column;text-align:center;} }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-container">
      <a href="index.html" class="logo"><span class="logo-symbol">L/0</span><span class="logo-text">Post-Labor Economics</span></a>
      <button class="nav-toggle" onclick="document.querySelector('.nav-menu').classList.toggle('open')" aria-label="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
      <nav class="nav-menu">
        <a href="projects.html" class="nav-link">Projects</a>
        <a href="content.html" class="nav-link">Content</a>
        <a href="proposals.html" class="nav-link">Proposals</a>
        <a href="discussions.html" class="nav-link">Discussions</a>
        <a href="architecture.html" class="nav-link">Architecture</a>
      </nav>
      <div class="header-actions">
        <span class="nav-link" data-user-name></span>
        <button class="btn btn-ghost" id="logout-btn">Sign Out</button>
      </div>
    </div>
  </header>

  <main>
    <div class="profile-container">
      <!-- Profile Card -->
      <div class="profile-card">
        <div class="profile-header">
          <div class="profile-avatar" id="avatar"></div>
          <div class="profile-info">
            <h1 id="display-name"></h1>
            <div class="role-badge" id="role-badge"></div>
            <div class="member-since" id="member-since"></div>
          </div>
        </div>

        <form id="profile-form">
          <div class="profile-form">
            <div class="form-row">
              <div class="form-group"><label>Display Name</label><input type="text" id="f-name" placeholder="Your name"></div>
              <div class="form-group"><label>Email</label><input type="email" id="f-email" disabled></div>
            </div>
            <div class="form-group"><label>Bio</label><textarea id="f-bio" rows="3" placeholder="Tell the community about yourself..."></textarea></div>
            <div class="form-actions">
              <button type="button" class="btn btn-ghost" id="cancel-btn" style="display:none">Cancel</button>
              <button type="submit" class="btn btn-primary" id="save-btn">Save Changes</button>
            </div>
          </div>
        </form>
      </div>

      <!-- Contributions -->
      <h3 class="section-label">Your Contributions</h3>
      <div class="contrib-grid">
        <div class="contrib-stat"><div class="contrib-stat-value" id="c-content">0</div><div class="contrib-stat-label">Content</div></div>
        <div class="contrib-stat"><div class="contrib-stat-value" id="c-proposals">0</div><div class="contrib-stat-label">Proposals</div></div>
        <div class="contrib-stat"><div class="contrib-stat-value" id="c-discussions">0</div><div class="contrib-stat-label">Discussions</div></div>
        <div class="contrib-stat"><div class="contrib-stat-value" id="c-votes">0</div><div class="contrib-stat-label">Votes Cast</div></div>
      </div>

      <!-- Recent Contributions -->
      <h3 class="section-label">Recent Activity</h3>
      <div class="contrib-list" id="activity-list">
        <div style="padding:2rem;text-align:center;color:var(--text-muted)">Loading...</div>
      </div>

      <!-- Danger Zone -->
      <div style="margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border-color);">
        <h3 class="section-label" style="color:#991B1B;">Account</h3>
        <div style="display:flex;gap:1rem;">
          <button class="btn btn-ghost" id="logout-btn-2">Sign Out</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    let currentUser = null, originalData = {};
    const authH = () => { const h={'Content-Type':'application/json'}; const t=localStorage.getItem('ple_token'); if(t) h['Authorization']=`Bearer ${t}`; return h; };
    function toast(m,e){const t=document.createElement('div');t.className='toast'+(e?' toast-error':'');t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.classList.add('show'),10);setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300)},3000);}
    function initials(n){return(n||'?').split(' ').map(w=>w[0]).join('').toUpperCase();}
    const cap=s=>s?s.charAt(0).toUpperCase()+s.slice(1):'';

    async function init(){
      const token=localStorage.getItem('ple_token');
      if(!token){window.location='login.html?redirect=profile.html';return;}
      try{
        const r=await fetch('/api/auth?action=me',{headers:{'Authorization':`Bearer ${token}`}});
        if(!r.ok){window.location='login.html?redirect=profile.html';return;}
        const d=await r.json(); currentUser=d.user||d;
        renderProfile();
        loadContributions();
        loadActivity();
      }catch(e){window.location='login.html?redirect=profile.html';}
    }

    function renderProfile(){
      document.getElementById('avatar').textContent=initials(currentUser.displayName);
      document.getElementById('display-name').textContent=currentUser.displayName;
      document.getElementById('role-badge').textContent=cap(currentUser.role||'member');
      document.getElementById('member-since').textContent='Member since '+new Date(currentUser.createdAt).toLocaleDateString('en-US',{month:'long',year:'numeric'});
      document.getElementById('f-name').value=currentUser.displayName||'';
      document.getElementById('f-email').value=currentUser.email||'';
      document.getElementById('f-bio').value=currentUser.bio||'';
      originalData={name:currentUser.displayName,bio:currentUser.bio||''};
      document.querySelectorAll('[data-user-name]').forEach(el=>el.textContent=currentUser.displayName);
    }

    async function loadContributions(){
      try{
        const [cR,pR]=await Promise.allSettled([
          fetch('/api/content?limit=50',{headers:authH()}).then(r=>r.json()),
          fetch('/api/proposals?limit=50',{headers:authH()}).then(r=>r.json())
        ]);
        if(cR.status==='fulfilled'){
          const my=cR.value.content.filter(c=>c.author?.id===currentUser.id);
          document.getElementById('c-content').textContent=my.length;
        }
        if(pR.status==='fulfilled'){
          const my=pR.value.proposals.filter(p=>p.author?.id===currentUser.id);
          document.getElementById('c-proposals').textContent=my.length;
        }
      }catch(e){}
    }

    async function loadActivity(){
      try{
        const r=await fetch(`/api/activity?userId=${currentUser.id}&limit=10`,{headers:authH()});
        const d=await r.json();
        const el=document.getElementById('activity-list');
        if(!d.activities?.length){el.innerHTML='<div style="padding:2rem;text-align:center;color:var(--text-muted)">No activity yet. Start contributing!</div>';return;}
        el.innerHTML=d.activities.map(a=>`<div class="contrib-item"><div><div class="contrib-item-title">${a.description}</div></div><div class="contrib-item-meta">${fmtRel(a.createdAt)}</div></div>`).join('');
      }catch(e){document.getElementById('activity-list').innerHTML='<div style="padding:2rem;text-align:center;color:var(--text-muted)">Unable to load activity</div>';}
    }

    function fmtRel(d){if(!d)return '';const ms=Date.now()-new Date(d).getTime();if(ms<60000)return 'just now';if(ms<3600000)return Math.floor(ms/60000)+'m ago';if(ms<86400000)return Math.floor(ms/3600000)+'h ago';if(ms<604800000)return Math.floor(ms/86400000)+'d ago';return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric'});}

    // Save profile
    document.getElementById('profile-form').addEventListener('submit',async e=>{
      e.preventDefault();
      const name=document.getElementById('f-name').value.trim();
      const bio=document.getElementById('f-bio').value.trim();
      if(!name){toast('Display name is required',true);return;}
      try{
        const r=await fetch('/api/auth?action=update-profile',{method:'POST',headers:authH(),body:JSON.stringify({displayName:name,bio})});
        if(r.ok){toast('Profile updated');currentUser.displayName=name;currentUser.bio=bio;renderProfile();}
        else{const d=await r.json();toast(d.error||'Update failed',true);}
      }catch(e){toast('Failed to update profile',true);}
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click',()=>{localStorage.removeItem('ple_token');window.location='index.html';});
    document.getElementById('logout-btn-2').addEventListener('click',()=>{localStorage.removeItem('ple_token');window.location='index.html';});

    init();
    lucide.createIcons();
  </script>
</body>
</html>
