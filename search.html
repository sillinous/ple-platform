<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="description" content="Search across all content, projects, proposals, and discussions on PLE.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search | Post-Labor Economics</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/icon-180.png">
  <link rel="icon" type="image/svg+xml" href="ple-logo.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,500;9..144,600;9..144,700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="src/styles/brand.css">
  <link rel="stylesheet" href="src/styles/app.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .search-container { max-width: 800px; margin: 0 auto; padding: 2rem 1.5rem 4rem; }
    .search-bar { display: flex; gap: 0.5rem; margin-bottom: 2rem; }
    .search-input { flex: 1; padding: 0.75rem 1rem; border: 2px solid var(--border-color, #e5e2dd); border-radius: 10px; font-family: inherit; font-size: 1rem; transition: border-color 0.15s; }
    .search-input:focus { outline: none; border-color: var(--color-horizon, #1B4D3E); }
    .search-btn { padding: 0.75rem 1.25rem; background: var(--color-horizon, #1B4D3E); color: white; border: none; border-radius: 10px; cursor: pointer; font-family: inherit; font-size: 0.9rem; font-weight: 500; }
    .search-btn:hover { opacity: 0.9; }
    .result-section { margin-bottom: 2rem; }
    .result-section-title { font-family: var(--font-display, serif); font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
    .result-count { font-size: 0.8rem; font-weight: 400; color: var(--text-muted, #888); }
    .result-item { display: block; padding: 0.75rem 1rem; border: 1px solid var(--color-gray-50, #eee); border-radius: 8px; margin-bottom: 0.5rem; text-decoration: none; color: inherit; transition: border-color 0.15s, background 0.15s; }
    .result-item:hover { border-color: var(--color-horizon, #1B4D3E); background: rgba(27,77,62,0.02); }
    .result-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem; }
    .result-excerpt { font-size: 0.85rem; color: var(--text-muted, #888); line-height: 1.5; }
    .result-meta { font-size: 0.75rem; color: var(--text-muted, #999); margin-top: 0.35rem; display: flex; gap: 0.75rem; }
    .result-badge { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 100px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; background: rgba(27,77,62,0.1); color: var(--color-horizon, #1B4D3E); }
    .no-results { text-align: center; padding: 3rem; color: var(--text-muted, #888); }
    .searching { text-align: center; padding: 2rem; color: var(--text-muted, #888); }
    .search-hint { text-align: center; padding: 3rem; color: var(--text-muted, #888); }
    .search-hint p { margin-bottom: 0.5rem; }
    mark { background: rgba(244,162,97,0.3); border-radius: 2px; padding: 0 1px; }
  </style>
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://postlaboreconomics.netlify.app/og-image.svg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://postlaboreconomics.netlify.app/og-image.svg">
</head>
<body>
  <header class="header">
    <div class="header-container">
      <a href="index.html" class="logo"><span class="logo-symbol">L/0</span><span class="logo-text">Post-Labor Economics</span></a>
      <button class="nav-toggle" aria-label="Toggle navigation" onclick="document.querySelector('.nav-menu').classList.toggle('open')" aria-label="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
      <nav class="nav-menu">
        <a href="content.html" class="nav-link">Content</a>
        <a href="projects.html" class="nav-link">Projects</a>
        <a href="proposals.html" class="nav-link">Proposals</a>
        <a href="discussions.html" class="nav-link">Discussions</a>
        <a href="about.html" class="nav-link">About</a>
      </nav>
            <div class="header-actions">
        <a href="architecture.html" class="nav-link" title="Architecture"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4m-2.6-7.4-2.8 2.8m-5.2 5.2-2.8 2.8m0-10.8 2.8 2.8m5.2 5.2 2.8 2.8"/></svg></a>
        <a href="search.html" class="nav-link" style="padding:0.4rem;display:flex" title="Search"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></a>
        <a href="login.html" class="btn btn-ghost" data-auth="logged-out" style="color:white;border-color:rgba(255,255,255,0.2)">Sign In</a>
        <a href="register.html" class="btn-hero-primary" data-auth="logged-out" style="font-size:0.85rem;padding:0.55rem 1.2rem">Join Us</a>
        <a href="dashboard.html" class="btn-hero-primary" data-auth="logged-in" style="display:none;font-size:0.85rem;padding:0.55rem 1.2rem">Dashboard</a>
      </div>
    </div>
  </header>

  <main>
    <div class="search-container">
      <h1 style="font-family:var(--font-display,serif);font-size:1.75rem;margin-bottom:1.5rem;">Search</h1>
      
      <div class="search-bar">
        <input type="text" class="search-input" id="q" placeholder="Search content, projects, proposals, discussions..." autofocus>
        <button class="search-btn" onclick="doSearch()">Search</button>
      </div>

      <div id="results">
        <div class="search-hint">
          <i data-lucide="search" style="width:48px;height:48px;opacity:0.15;margin-bottom:1rem;display:block;margin-left:auto;margin-right:auto;"></i>
          <p>Search across all platform content</p>
          <p style="font-size:0.85rem;">Try searching for topics like "UBI", "automation", or "governance"</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    const esc=s=>{const d=document.createElement('div');d.textContent=s;return d.innerHTML;};
    function highlight(text,q){if(!q||!text)return esc(text||'');const re=new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');return esc(text).replace(re,'<mark>$1</mark>');}
    function trunc(s,n){return(s||'').length>n?(s||'').substring(0,n)+'...':s||'';}
    function cap(s){return s?s.charAt(0).toUpperCase()+s.slice(1).replace(/_/g,' '):''}

    document.getElementById('q').addEventListener('keydown',e=>{if(e.key==='Enter')doSearch();});

    // Check URL for query param
    const urlQ=new URLSearchParams(window.location.search).get('q');
    if(urlQ){document.getElementById('q').value=urlQ;doSearch();}

    async function doSearch(){
      const q=document.getElementById('q').value.trim();
      if(!q){return;}
      
      // Update URL
      history.replaceState(null,'',`?q=${encodeURIComponent(q)}`);
      
      const el=document.getElementById('results');
      el.innerHTML='<div class="searching">Searching across knowledge base, content, proposals & discussions...</div>';

      try{
        const res=await fetch(`/api/smart-search?q=${encodeURIComponent(q)}&scope=all&limit=30`);
        const data=await res.json();

        const kbMatches=data.kb_matches||[];
        const dbResults=data.results||[];
        const total=kbMatches.length+dbResults.length;

        if(total===0){el.innerHTML='<div class="no-results"><p>No results found for "'+esc(q)+'"</p><p style="font-size:0.85rem;margin-top:0.5rem;">Try different keywords or ask the <a href="/chat" style="color:var(--color-horizon);">AI Assistant</a>.</p></div>';return;}

        let html='';

        // KB framework matches (highest value — core theory)
        if(kbMatches.length){
          html+=`<div class="result-section"><div class="result-section-title"><i data-lucide="book-open" style="width:18px;height:18px"></i>Knowledge Base <span class="result-count">(${kbMatches.length})</span></div>`;
          html+=kbMatches.map(m=>{
            const section=m.section||m.key||'';
            const label=section.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
            return `<div class="result-item" style="cursor:default;"><div class="result-title">${highlight(label,q)}</div><div class="result-excerpt">${highlight(trunc(m.text||m.content||m.value||'',200),q)}</div><div class="result-meta"><span class="result-badge">Framework</span><span>${section}</span></div></div>`;
          }).join('');
          html+='</div>';
        }

        // Group DB results by type
        const content=dbResults.filter(r=>r.type==='content');
        const proposals=dbResults.filter(r=>r.type==='proposal');
        const discussions=dbResults.filter(r=>r.type==='discussion');

        if(content.length){
          html+=`<div class="result-section"><div class="result-section-title"><i data-lucide="file-text" style="width:18px;height:18px"></i>Content <span class="result-count">(${content.length})</span></div>`;
          html+=content.map(c=>`<a href="content-view.html?id=${c.id}" class="result-item"><div class="result-title">${highlight(c.title,q)}</div><div class="result-excerpt">${highlight(trunc(c.excerpt||'',150),q)}</div><div class="result-meta"><span class="result-badge">${cap(c.content_type||'article')}</span><span>${cap(c.status||'')}</span></div></a>`).join('');
          html+='</div>';
        }
        if(proposals.length){
          html+=`<div class="result-section"><div class="result-section-title"><i data-lucide="vote" style="width:18px;height:18px"></i>Proposals <span class="result-count">(${proposals.length})</span></div>`;
          html+=proposals.map(p=>`<a href="proposal-view.html?id=${p.id}" class="result-item"><div class="result-title">${highlight(p.title,q)}</div><div class="result-excerpt">${highlight(trunc(p.content||'',150),q)}</div><div class="result-meta"><span class="result-badge">Proposal</span><span>${cap(p.status||'')}</span></div></a>`).join('');
          html+='</div>';
        }
        if(discussions.length){
          html+=`<div class="result-section"><div class="result-section-title"><i data-lucide="message-square" style="width:18px;height:18px"></i>Discussions <span class="result-count">(${discussions.length})</span></div>`;
          html+=discussions.map(d=>`<a href="discussion-view.html?id=${d.id}" class="result-item"><div class="result-title">${highlight(d.title||'Untitled',q)}</div><div class="result-excerpt">${highlight(trunc(d.content||'',150),q)}</div><div class="result-meta"><span class="result-badge">Discussion</span><span>${d.reply_count||0} replies</span></div></a>`).join('');
          html+='</div>';
        }

        // AI suggestion
        html+=`<div style="text-align:center;margin-top:2rem;padding:1rem;background:rgba(244,162,97,0.08);border-radius:10px;"><p style="font-size:0.85rem;color:var(--text-muted,#666);">Want a deeper answer? <a href="/chat" style="color:var(--color-horizon);font-weight:600;">Ask the AI Assistant →</a></p></div>`;
        
        el.innerHTML=html;
        lucide.createIcons();
      }catch(e){
        console.error(e);
        el.innerHTML='<div class="no-results"><p>Search failed. Please try again.</p></div>';
      }
    }

    // Init auth UI
    (async()=>{
      const token=localStorage.getItem('ple_token');
      if(token){try{const r=await fetch('/api/auth?action=me',{headers:{'Authorization':`Bearer ${token}`}});if(r.ok){document.querySelectorAll('[data-auth="logged-in"]').forEach(el=>el.style.display='');document.querySelectorAll('[data-auth="logged-out"]').forEach(el=>el.style.display='none');}}catch(e){}}
      lucide.createIcons();
    })();
  </script>
  <footer style="margin-top:4rem;padding:2rem 0;border-top:1px solid var(--border-color,#e5e2dd);text-align:center;font-size:0.8rem;color:var(--text-muted,#888);">
    <div style="max-width:1200px;margin:0 auto;padding:0 1.5rem;">
      <a href="index.html" style="text-decoration:none;color:inherit;font-weight:600;">L/0</a> Post-Labor Economics · Prosperity Beyond Work
    </div>
  </footer>
<script src="/chat-widget.js" defer></script>
</body>
</html>
